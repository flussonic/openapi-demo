
# Облако

Видеостриминговое облако флюссоника призвано снять с клиента все проблемы, связанные с видео,
позволив ему сконцентрироваться на своей бизнес-логике. Для этого оно должно:

1. снять необходимость разрабатывать своё видеостриминговое решение
2. снять необходимость поддерживать работоспособность своего видеостримингового решения
3. снять необходимость подбирать хостинг и CDN под видеорешение



# Целевые применения

1. OTT телевидение
2. Трансляция событий
3. Прием и запись IP камер
4. Видеоаналитика


# Основные понятия


**stream (поток)** — протяженный аудиовидео поток данных без явного конца и существующий в привязке к реальному времени.

**media asset (видеофайл)** — аудиовидео ролик, имеющий начало и конец и существующий независимо от текущего времени.

**player (плеер)** — то, что ходит к публичной части облака для того, чтобы проиграть видео или получить его публично доступную конфигурацию.

**viewer (зритель)** — тот, кто использует player и просматривает видео.


**account (клиент)** — клиент облака, который платит деньги за его использование и имеющий возможность управлять своей конфигурацией оказания услуг. Идентификатор клиента — его **account_id**

**resource (единица учета)**, - то, что клиент потребляет, а мы умеем подсчитывать. Может быть трафиком, временем использования, количеством запросов и т.п.

**project (проект)** — сущность в рамках которой клиент потребляет ресурсы облака согласно установленному прайсу. Идентификатор клиента — его **project_id** Один клиент может 

**billig (биллинг)** — механизм, подсчитывающий реальное потребление ресурсов облака клиентом и списывающий с него деньги.

**price (тарифный план)** — договоренность с клиентом о цене на потребленные набора **resource** в рамках проекта **project**


# Услуги

Облако поддерживает следующие услуги связанные с видео:

* захват потока из внешнего источника
* транскодирование потока
* запись потока для последующего проигрывания и неограниченное хранение
* проигрывание с доставкой до клиента (CDN)
* предоставление кроссплатформенных плееров
* гибкая авторизация проигрывания


На ближайшее будущее планы:

* прием публикации потока извне. Проблема в том, что это не делается протоколами, поддерживающими редирект.
* передача локально захваченного отдельным агентом потока в облако
* загрузка, транскодирование рекламных роликов. Их открутка и учет.
* загрузка и транскодирование контентных роликов. Их разметка по времени, прочий Media asset management.
* формирование плейлиста и собственного потока из загруженных роликов. Облачный playout.
* геораспределенность точек приема публикации и захвата (учитывая распределенную доставку до клиента, получается полная геодоставка)
* поддержка DRM

# API

Облако предоставляет два публичных документированных API: операторское и плеерное. Для внутренних нужд админское API.

Операторское API позволяет управлять контентом и правилами его обработки и доступно только при авторизации.
Оно доступно по одному урлу.

Плеерное API позволяет проигрывать контент и необходимость использования авторизации — выбор оператора.
Оно доступно по другому урлу и специфично этот урл специфичен для клиента.

Админское API нужно для нас и позволяет управлять состоянием облака, мониторить его, диагностировать, раскладывать конфигурацию.


## Операторское API

В целом операторское апи повторяет ту часть API флюссоника, которая имеет смысл в облачном сервисе.

Удивительно, но это настолько небольшая часть, что по сути остается только то апи, которое мы придумывали для катены.
В облаке оператору доступно управление следующими сущностями:

* стримы
* темплейты
* авторизационные бекенды
* вебхуки (?)
* история апи вызовов, потребления ресурсов и прочих billable items.
* предоставление доступа другим субоператорам


Отличие от катены в том, что в ней мы вообще не давали настраивать отдельные стримы (каналы), а тут вроде пока разрешаем.

Так же в катене мы допускали ручное редактирование конфигурации на местах, а в клауде конечно же нет.

Из соображений удобства, в операторском апи будет отсутствовать tenant_id где либо, кроме авторизации.

Т.е. список имен стримов плоский и без префикса. Весь контент и прочие именованные сущности видны под теми именами,
которые выбрал клиент.

## Плеерное API

Плееры могут проигрывать с облака напрямую, оно должно принимать на себя терабитный трафик и десятки тысяч RPS.

К плеерному апи обращаются для того, чтобы оно отредиректило на работающий стример. 

Допускается, что балансировщик будет отдавать не только редиректы, но и текстовые ответы, например отдавать HLS плейлист с особым образом сформированными урлами битрейтных плейлистов.

Плеерное API подразумевается для использования под доменным именем клиента.

В плеерном API мы будем принимать плеерную статистику для формирования отчетов клиенту.


## Админское API

Позволяет управлять конфигурацией облака, управлять стримерами, управлять операторами, тарифными планами.

В админском API будем использовать Snowflake ID  https://en.wikipedia.org/wiki/Snowflake_ID для идентификации объектов в облаке (проекты, севера, прайсы, транзакции)



# Структура

Облако состоит из следующих слабо связанных деталей:

* **Стриминговая часть.** Развернутые флюссоники, которые настроены так, что в условиях достаточной емкости сети и серверов и без аварий, эта часть может функционировать, оказывать услугу без остальной части. Т.е. тут нет ничего, чтобы зависело от остальных компонент.
* **Балансировщик.** Фронтальная часть облака, к ней самые высокие требования по скорости ответа, устойчивости, геораспределенности. Всё, что он делает - редиректит плеер на заведомо работающий флюссоник. Отвечает на плеерное API. Считаем, что балансировщик может обратиться к флюссонику для получения рантайм данных о потоках, а так же должен сходить к базе данных контента клиента для получения информации о его потоках.
* **Оркестратор.** Та часть, которая отвечает на операторское API. Требования к устойчивости понижены, должна принимать от оператора новые конфигурации по API и конфигурировать флюссоники так, чтобы требуемая конфигурация работала даже в случае, когда какой-то из стримеров сломался или даже не работал. Оркестратор не обязан реагировать на изменения стриминговой сети в реальном времени.
* **Коллектор** — механизм, собирающий реальную статистику использования. Помимо обычной телеметрии для отладки и мониторинга, задача коллектора — получить реальные точные данные для биллинга. Всё что здесь будет потеряно, будет нами недозаработано.
* **Admin UI** — админка клиента, в которой он может управлять облаком через операторское API. Текущая идея заключается в том, чтобы держать это всё единообразным и синхронизированным с флюссоником.


Текущая гипотеза в том, что мы сможем написать оркестратор так, чтобы в нём была катена, по крайней мере в той части,
которая отвечает за раскладку конфигурации по флюссоникам.


# Пространства имен

При проектировании апи облака пришлось особенное внимание уделить пространствам имен.
Поскольку облаком пользуются разные люди, то они никак не должны влиять друг на друга, не должны иметь возможность узнать, что у кого-то из других клиентов есть какой-то контент.

Для этого мы вводим понятие project_id, идентификатор проекта, который будет повсеместно использоваться в качестве составной части имен контента.

В именах контента (стримах и т.п.) запрещены слеши, это важно, потому что для роутинга нам надо точно знать,
сколько сегментов может быть в имени стрима.

Так в облаке имя стрима это везде и всегда `{project_id}_{user_provided_name}`

Важный момент связан с публикацией.

1. Для стримов с `input publish://` публикация в облако будет выглядеть `/{project_id}_{user_provided_name}?{params}`
2. Для проектов с разрешенным `named_by_user` публикация будет выглядеть как  `/{project_id}_{user_provided_name}?{params}`




# Публикация

Публикация очень неприятная часть из-за того, что:

* даже HTTP клиенты плохо поддерживают редирект на публикации. Т.е. мы не можем сделать балансировщик на публикацию.
* прочие протоколы вообще не поддерживают редирект, тем более при публикации.
* большинство протоколов устроены так, что без начала хендшейка, просто подсмотрев в первый пакет, нельзя определить ничего про этот протокол и определить на какой сервер его отправлять.
* по сути у нас есть DNS балансировка и это основа на которую мы можем рассчитывать.
* anycast штука интересная, хотя и нестабильная. Воспользоваться ей сможем очень нескоро.

Выглядит, что в качестве основы мы выберем DNS балансировку, а так же API, позволяющее получить урл для публикации перед началом публикации.
Скорее всего этим API будут мало пользоваться, но мы хотя бы скажем: мы же вас предупреждали.


# Оркестратор

Клиенты (операторы) в нём появляются путем провижнининга через OAuth с my.flussonic.com через его OAuth2 механизм.

К оркестратору мы даем наш UI в котором доступны все сущности облака.

Дизайн той части оркесторатора, которая раскладывает конфигурацию по облаку будет осуществлен в начале января.


# Ресурсы облака

Обязательные свойства ресурс облака:
- уникальное имя
- заданный способ замера расхода ресурса (counter, gauge). Cпособ замера не изменяется за время жизни ресурса (меняется способ - появляется ресурс с новым именем)
- цена в условных единицах облака на определнную дату
- облако умеем предоставлять этот ресурс в рамках проекта

Русурсы облака определяются простым плоским списком единым для всех компонентов облака.

Процесс добавления нового ресурса в облако:
- придумать имя
- придумать способ замера расхода ресурса
- проверить что новый способ замера не пересекается с существующим и разрешить ситуацию с двойным расходом
- реализовать коллектор для этого ресурса
- определить прайс для этого ресурса в билинге
- реализовать предоставление этого ресурса в рамках проекта

# Коллектор

На текущий момент мы хотим, чтобы стриминговая часть не зависела от питонячего API. Т.е. чтобы не было ситуации при которой флюссоник пытается при старте обратиться к питонячьему апи и из-за 50% дропа пакетов или чего ещё, не может обслужить клиента просто из-за тупящего коллектора.

Таким образом это задача коллектора сходить к флюссонику и получить актуальные данные о потреблении.

При этом мы ожидаемо теряем некоторую риалтаймовость и возможно даже какой-то объём данных при аварии серверов, но пока это терпимая потеря.
Одих из допустимых вариантов — локальное складирование статистики на флюссониках.

В качестве основы этого апи, мы видим подход со счетчиками в стиле прометеуса: бесконечно накапливающиеся счетчики (байт, времени) и время от которого происходит старт текущего сбора (фактически идентификатор сессии сбора). В таком виде у нас уже есть сессии и
мы готовы написать повторно тот же коллектор, что и сессии в кликхаусе. Это ожидаемая плата и двойная работа для того, чтобы проверить
работоспосоность нашей системы сессий.

Задача коллектора хранить или историю замеров, или только результат. Вполне возможно, что мы будем хранить и то, и то, но историю стирать через какое-то время.


# Биллинг

На январь 2022 мы остановились на следующих концепциях:

* облако не занимается деньгами, это делает только биллинг. Вместо этого оно знает баланс клиента в условных единицах.
* облако умеет считать потребление ресурсов, пересчитывать это в условные единицы и списывать их
* облако умеет отключать клиента при обнулении баланса в условных единицах.
* задача биллинга следить за балансом клиента (опрашивая облако)
* вокруг аккаунта в биллинге нужно спроектировать четкое апи, умеющее добавлять как валюту клиенту, так и списания ресурсов




проблема: коллектор собирает prometheus-like appendable данные, которые плохо стыкуются с учетными периодами.
надо это всё задизайнить.






# Вопросы

* не хотим ли мы вернуться к концепции каналов и пайплайнов в нашем облаке?
* задизайнить оркестратор
* поменять в дизайне Руслана для клауда термины с items на соответствующие нашим стандартам термины типа `accounts`
* в cloud убрать из под /admin/ аккаунты
* спроектировать state machine для учета списания валюты биллинга
















